<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hello World</title>
</head>

<body>

    <!--First, make sure socket.io is available to your project.-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>

    <script>

        // Next, create a socket.io connection to heat-ebs.j38.net.
        const socket = io('wss://heat-ebs.j38.net/');

        // Once connected, join a Twitch channel with your numeric channel id.
        socket.on('connect', () => {
            socket.emit("channel", 97032862);
        });

        // Now, listen for click events.
        socket.on('click', (data) => {
            const clickData = JSON.parse(data);

            // Finally, use the click coordinates to create your experience.
            console.log(clickData);
        });

        //
        // Raw Websockets.
        //

        function connect() {
            let ws = new WebSocket('wss://heat-ebs.j38.net/');

            ws.addEventListener('open', function open() {
                console.log("WS OPEN");
                ws.send(JSON.stringify({ channel: 97032862 }));
            });

            ws.addEventListener('message', function incoming(message) {
                let jsonData = JSON.parse(message.data);
                if (jsonData.type == "click") {
                    console.log(jsonData);
                    getUser(jsonData.id);
                }
                if (jsonData.type == "grid") {
                    console.log(jsonData);
                    getUser(jsonData.id);
                }
            });

            ws.addEventListener('error', function (e) {
                console.log("ERROR");
                console.log(e);
            });

            ws.addEventListener('close', function (e) {
                console.log("CLOSE");
                console.log(e);
                ws = null
                setTimeout(connect, 1000)
            });
        }

        connect();


        //

        function getUser(id) {

            if (id.startsWith("A") || id.startsWith("U")) {
                console.log("Bad user.");
                return false;
            }

            const url = `https://api.twitch.tv/kraken/users/${id}`;

            const httpRequest = new XMLHttpRequest();
            httpRequest.open("GET", url, true);

            httpRequest.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json');
            httpRequest.setRequestHeader('Client-ID', 'cr20njfkgll4okyrhag7xxph270sqk');

            httpRequest.onload = function (e) {
                if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                        let responseData = JSON.parse(httpRequest.responseText);
                        console.log(responseData.display_name);
                    } else {
                        console.log(httpRequest.responseText);
                        console.log(httpRequest.status);
                        console.log(httpRequest.statusText);
                    }
                }
            };

            httpRequest.send();

        }

    </script>

</body>

</html>